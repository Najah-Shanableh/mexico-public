DROP TABLE IF EXISTS layla.aggregated_births_muni_level;

CREATE TABLE layla.aggregated_births_muni_level AS (
	select table_year as year,count(*) as births,
			   sum((con_ubic = 0)::int) as urban_births,
			   sum((con_ubic > 0)::int) as rural_births,
			   sum((facility_type2 like '%01%')::int) as basico_births,
			   sum((facility_type2 not like '%01%')::int) as non_basico_births,
			   concat(mother_res_state::text,mother_res_muni) as municipality,
			   sum(case when attending_personnel = 1 then 1 else 0 end) as attending_personnel_1,
			   sum(case when attending_personnel = 2 then 1 else 0 end) as attending_personnel_2,
			   sum(case when attending_personnel = 3 then 1 else 0 end) as attending_personnel_3,
			   sum(case when attending_personnel = 4 then 1 else 0 end) as attending_personnel_4,
			   sum(case when attending_personnel = 8 then 1 else 0 end) as attending_personnel_8,
			   sum(case when attending_personnel = 9 then 1 else 0 end) as attending_personnel_9,
			   sum(case when birth_procedure = 1 then 1 else 0 end) as birth_procedure_1,
			   sum(case when birth_procedure = 2 then 1 else 0 end) as birth_procedure_2 ,
			   sum(case when birth_procedure = 3 then 1 else 0 end) as birth_procedure_3,
			   sum(case when birth_procedure = 8 then 1 else 0 end) as birth_procedure_8,
			   sum(case when birth_procedure = 9 then 1 else 0 end) as birth_procedure_9,
			   sum(case when twins = 1 then 1 else 0 end) as single_multiple_fetus_1,	
			   sum(case when twins = 2 then 1 else 0 end) as single_multiple_fetus_2,	
			   sum(case when twins = 3 then 1 else 0 end) as single_multiple_fetus_3,	
			   sum(case when twins = 9 then 1 else 0 end) as single_multiple_fetus_9,	
			   sum(case when mother_health_affiliation = 1 then 1 else 0 end) as insurance_1,	
			   sum(case when mother_health_affiliation = 2 then 1 else 0 end) as insurance_2,	
			   sum(case when mother_health_affiliation = 3 then 1 else 0 end) as insurance_3,	
			   sum(case when mother_health_affiliation = 4 then 1 else 0 end) as insurance_4,	
			   sum(case when mother_health_affiliation = 5 then 1 else 0 end) as insurance_5,	
			   sum(case when mother_health_affiliation = 6 then 1 else 0 end) as insurance_6,	
			   sum(case when mother_health_affiliation = 7 then 1 else 0 end) as insurance_7,	
			   sum(case when mother_health_affiliation = 8 then 1 else 0 end) as insurance_8,	
			   sum(case when mother_health_affiliation = 10 then 1 else 0 end) as insurance_10,	
			   sum(case when mother_health_affiliation = 88 then 1 else 0 end) as insurance_88,	
			   sum(case when mother_health_affiliation = 99 then 1 else 0 end) as insurance_99,	
			   avg(total_parental_consultations) as average_parental_consultations,	
			   sum(case when place_of_birth = 1 then 1 else 0 end) as place_of_birth_1,	
			   sum(case when place_of_birth = 2 then 1 else 0 end) as place_of_birth_2,	
			   sum(case when place_of_birth = 3 then 1 else 0 end) as place_of_birth_3,	
			   sum(case when place_of_birth = 4 then 1 else 0 end) as place_of_birth_4,	
			   sum(case when place_of_birth = 5 then 1 else 0 end) as place_of_birth_5,	
			   sum(case when place_of_birth = 6 then 1 else 0 end) as place_of_birth_6,	
			   sum(case when place_of_birth = 7 then 1 else 0 end) as place_of_birth_7,	
			   sum(case when place_of_birth = 8 then 1 else 0 end) as place_of_birth_8,	
			   sum(case when place_of_birth = 10 then 1 else 0 end) as place_of_birth_10,	
			   sum(case when place_of_birth = 11 then 1 else 0 end) as place_of_birth_11,	
			   sum(case when place_of_birth = 12 then 1 else 0 end) as place_of_birth_12,	
			   sum(case when place_of_birth = 13 then 1 else 0 end) as place_of_birth_13,	
			   sum(case when place_of_birth = 99 then 1 else 0 end) as place_of_birth_99,	
			   avg(mother_pregnancies) as average_mother_pregnancies,	
			   sum(case when  mother_parental_care = 1 then 1 else 0 end) as parental_care_1,	
			   sum(case when  mother_parental_care = 2 then 1 else 0 end) as parental_care_2,	
			   sum(case when  mother_parental_care = 8 then 1 else 0 end) as parental_care_8,	
			   sum(case when  mother_parental_care = 9 then 1 else 0 end) as parental_care_9	
from public.births_data
join localities on cve_loc = concat(mother_res_state::text,mother_res_muni, mother_res_loc)
join clues_data on births_data.clues_code = clues_data.clues_code
group by year,mother_res_state,mother_res_muni order by year,municipality
);
